<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>loki</title>
</head>
<body>
<script src="https://cdn.bootcdn.net/ajax/libs/lokijs/1.5.9/lokijs.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/lokijs/1.5.9/loki-indexed-adapter.min.js"></script>
<script type="module">
    console.log('run')

    var adapter = new LokiIndexedAdapter();
    var db = new loki('Example');

    db.loadDatabase({}, error => {
        error && console.log(error)
    })
    const coll = db.getCollection('users')

    console.log('判断是否存在 collection', coll)

    if (!coll) {
        console.log('无 coll, 需要创建 users')
        // create col
        var users = db.addCollection('users', {indices: ['email']});
        // add data
        var odin = users.insert({name: 'odin', email: 'odin.soap@lokijs.org', age: 38});
        var thor = users.insert({name: 'thor', email: 'thor.soap@lokijs.org', age: 25});
        var stan = users.insert({name: 'stan', email: 'stan.soap@lokijs.org', age: 29});
        var oliver = users.insert({name: 'oliver', email: 'oliver.soap@lokijs.org', age: 31});
        var hector = users.insert({name: 'hector', email: 'hector.soap@lokijs.org', age: 15});
        var achilles = users.insert({name: 'achilles', email: 'achilles.soap@lokijs.org', age: 31});

        db.saveDatabase(error => {
            console.log('保存数据')
            error && console.log(error)
        })
    }

    // 获取数据-直接调用

    const dv = coll.addDynamicView('test');

    dv.applyFind({'name': 'odin'});

    const results = dv.data();

    console.log('获取数据 1', results)

    // ------------

    const dv2 = coll.addDynamicView('test2');

    dv2.applyWhere(function (obj) {
        return obj.name === 'oliver';
    });

    const results2 = dv2.data();

    console.log('获取数据 2', results2)

    // ------------

    const dv3 = coll.addDynamicView('test3');

    dv3.applySimpleSort("age");

    console.log(dv3)

    const results3 = dv3.data();

    console.log('获取数据 3', results3)


    // -------------


    const results4 = coll.find({'age': {'$aeq': 15}});

    console.log('获取数据 4',results4)

    // -------------


    const results5 = coll.findOne({'age': {'$aeq': 31}});

    console.log('获取数据 5',results5)

    // -------------


    const results6 = coll.findObject({'age': 38});

    console.log('获取数据 6',results6)

    // -------------


    const results7 = coll.findObjects({'age': 31});

    console.log('获取数据 7',results7)


    // 获取数据-链式调用

    const resultsLine1 = coll.chain().data();

    console.log('获取数据chain 1', resultsLine1)

    // ------------

    const resultsLine2 = coll.chain().find({'name': 'odin'}).data();

    console.log('获取数据chain 2', resultsLine2)

    // ------------

    const resultsLine3 = coll.chain().simplesort('age').data();

    console.log('获取数据chain 3', resultsLine3)

    // 修改:
    const item = coll.findOne({'age': {'$aeq': 31}});

    item.age = 18

    coll.update(item);

    console.log('修改结果 1',coll.chain().data())


    // 删除:
    const item2 =  coll.findOne({'age': {'$aeq': 31}});

    coll.remove(item2);

    console.log('删除结果 1',coll.chain().data())

    // TODO  commit  eqJoin addTransform
</script>
</body>
</html>
